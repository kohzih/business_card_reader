# 名刺読み取りアプリ実装指示書

## 概要
名刺画像をアップロードして、Gemini 2.5 Flash APIで読み取り、結果を表示するRails 8アプリケーションを作成する。

## 技術スタック
- Rails 8
- SQLite（開発環境）
- Active Storage（画像管理）
- Gemini 2.5 Flash API
- Tailwind CSS（スタイリング）
- `google-generative-ai` gem

## 機能要件
1. 名刺画像のアップロード画面
2. Gemini APIによる画像解析（リアルタイム処理）
3. 読み取り結果の表示画面

## セットアップ手順

### 1. Rails アプリケーション作成
```bash
rails new business_card_reader --database=sqlite3
cd business_card_reader
```

### 2. Gemfile編集
```ruby
# Gemfile に追加
gem 'google-generative-ai'
gem 'image_processing', '~> 1.2'  # Active Storage用
```

### 3. bundle install
```bash
bundle install
```

### 4. Active Storage セットアップ
```bash
rails active_storage:install
rails db:migrate
```

### 5. 認証情報設定
```bash
# credentials.yml.enc を編集
EDITOR="code --wait" rails credentials:edit
```

以下を追加：
```yaml
google_generative_ai_key: YOUR_API_KEY_HERE
```

## データベース設計

### マイグレーションファイル作成
```bash
rails generate model BusinessCard full_name:string company_name:string department:string post:string telephone_number:string mail:string address:text raw_response:text
rails db:migrate
```

## 実装ファイル

### 1. モデル
**app/models/business_card.rb**
```ruby
class BusinessCard < ApplicationRecord
  has_one_attached :image
  
  validates :image, presence: true
  validate :image_format

  private

  def image_format
    return unless image.attached?
    
    unless image.blob.content_type.in?(['image/jpeg', 'image/jpg', 'image/png'])
      errors.add(:image, 'はJPEGまたはPNG形式でアップロードしてください')
    end
  end
end
```

### 2. ルーティング
**config/routes.rb**
```ruby
Rails.application.routes.draw do
  root 'business_cards#new'
  resources :business_cards, only: [:new, :create, :show]
end
```

### 3. コントローラー
**app/controllers/business_cards_controller.rb**
```ruby
class BusinessCardsController < ApplicationController
  def new
    @business_card = BusinessCard.new
  end

  def create
    @business_card = BusinessCard.new(business_card_params)
    
    if @business_card.save
      # Gemini APIで解析
      analysis_result = GeminiService.analyze_business_card(@business_card.image)
      
      if analysis_result[:success]
        @business_card.update(analysis_result[:data])
        redirect_to @business_card, notice: '名刺を正常に読み取りました'
      else
        @business_card.update(raw_response: analysis_result[:error])
        redirect_to @business_card, alert: '読み取りに失敗しました'
      end
    else
      render :new, status: :unprocessable_entity
    end
  end

  def show
    @business_card = BusinessCard.find(params[:id])
  end

  private

  def business_card_params
    params.require(:business_card).permit(:image)
  end
end
```

### 4. Gemini API サービス
**app/services/gemini_service.rb**
```ruby
require 'google/generative_ai'

class GeminiService
  PROMPT = <<~PROMPT
    名刺の画像データを読み取ったテキストから次の情報を抽出してください。
    各項目は、括弧内のラベルで出力してください:
    - 氏名（苗字、名前を分けて抽出、full_name）
    - 会社名（日本語の場合は日本語で記載、company_name）
    - 部署（department）
    - 役職（「社長」、「部長」、「リーダー」、「マネージャー」など、post）
    - 電話番号（telephone_number）
    - メールアドレス（mail）
    - 住所（会社の住所、address）
    
    該当項目の情報がない場合は、空白で構いません。
    同じ情報が複数あると思われる場合は、より上部に書かれている方を優先してください。
    漢数字は半角の数字に変換してください。
    
    結果はJSON形式で返してください。
    例: {"full_name": "山田太郎", "company_name": "株式会社サンプル", "department": "営業部", "post": "部長", "telephone_number": "03-1234-5678", "mail": "yamada@sample.com", "address": "東京都渋谷区..."}
  PROMPT

  def self.analyze_business_card(image_attachment)
    return { success: false, error: 'Image not found' } unless image_attachment.attached?

    begin
      client = Google::GenerativeAI::Client.new(
        api_key: Rails.application.credentials.google_generative_ai_key
      )
      
      # 画像をbase64エンコード
      image_data = image_attachment.blob.download
      base64_image = Base64.strict_encode64(image_data)
      
      response = client.generate_content(
        model: 'gemini-2.5-flash',
        contents: [
          {
            parts: [
              { text: PROMPT },
              {
                inline_data: {
                  mime_type: image_attachment.blob.content_type,
                  data: base64_image
                }
              }
            ]
          }
        ]
      )
      
      # レスポンスからJSONを抽出
      content_text = response.dig('candidates', 0, 'content', 'parts', 0, 'text')
      
      if content_text
        # JSON部分を抽出（```json...```の場合もあるため）
        json_match = content_text.match(/\{.*\}/m)
        if json_match
          parsed_data = JSON.parse(json_match[0])
          return {
            success: true,
            data: parsed_data.merge(raw_response: content_text)
          }
        end
      end
      
      { success: false, error: 'Failed to parse response', raw_response: content_text }
      
    rescue JSON::ParserError => e
      { success: false, error: "JSON parse error: #{e.message}", raw_response: content_text }
    rescue => e
      { success: false, error: "API error: #{e.message}" }
    end
  end
end
```

### 5. ビュー

#### アプリケーションレイアウト
**app/views/layouts/application.html.erb**
```erb
<!DOCTYPE html>
<html>
  <head>
    <title>Business Card Reader</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>
    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body class="bg-gray-50">
    <% if notice %>
      <div class="bg-green-50 border border-green-200 rounded-md p-4 mb-4">
        <p class="text-green-800"><%= notice %></p>
      </div>
    <% end %>
    
    <% if alert %>
      <div class="bg-red-50 border border-red-200 rounded-md p-4 mb-4">
        <p class="text-red-800"><%= alert %></p>
      </div>
    <% end %>

    <%= yield %>
  </body>
</html>
```

#### 新規作成画面
**app/views/business_cards/new.html.erb**
```erb
<div class="container mx-auto px-4 py-8">
  <h1 class="text-2xl font-bold mb-6">名刺読み取り</h1>
  
  <%= form_with model: @business_card, local: true, multipart: true, 
                class: "space-y-6" do |form| %>
    <% if @business_card.errors.any? %>
      <div class="bg-red-50 border border-red-200 rounded-md p-4">
        <ul class="text-red-600">
          <% @business_card.errors.full_messages.each do |message| %>
            <li><%= message %></li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <div>
      <%= form.label :image, "名刺画像", class: "block text-sm font-medium text-gray-700 mb-2" %>
      <%= form.file_field :image, 
                          accept: "image/jpeg,image/jpg,image/png",
                          class: "block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" %>
      <p class="text-sm text-gray-500 mt-1">JPEG、PNG形式のファイルをアップロードしてください</p>
    </div>

    <div>
      <%= form.submit "読み取り開始", 
                      class: "bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" %>
    </div>
  <% end %>
</div>
```

#### 表示画面
**app/views/business_cards/show.html.erb**
```erb
<div class="container mx-auto px-4 py-8">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold">読み取り結果</h1>
    <%= link_to "新しい名刺を読み取る", new_business_card_path, 
                class: "bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-md" %>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
    <!-- 名刺画像 -->
    <div>
      <h2 class="text-lg font-semibold mb-4">アップロードした画像</h2>
      <div class="border border-gray-300 rounded-lg p-4">
        <%= image_tag @business_card.image, 
                      class: "max-w-full h-auto rounded-md shadow-sm" if @business_card.image.attached? %>
      </div>
    </div>

    <!-- 読み取り結果 -->
    <div>
      <h2 class="text-lg font-semibold mb-4">読み取り結果</h2>
      <div class="space-y-4">
        <div class="bg-gray-50 rounded-lg p-4">
          <dl class="space-y-3">
            <div>
              <dt class="font-medium text-gray-700">氏名</dt>
              <dd class="text-gray-900"><%= @business_card.full_name.presence || "取得できませんでした" %></dd>
            </div>
            <div>
              <dt class="font-medium text-gray-700">会社名</dt>
              <dd class="text-gray-900"><%= @business_card.company_name.presence || "取得できませんでした" %></dd>
            </div>
            <div>
              <dt class="font-medium text-gray-700">部署</dt>
              <dd class="text-gray-900"><%= @business_card.department.presence || "取得できませんでした" %></dd>
            </div>
            <div>
              <dt class="font-medium text-gray-700">役職</dt>
              <dd class="text-gray-900"><%= @business_card.post.presence || "取得できませんでした" %></dd>
            </div>
            <div>
              <dt class="font-medium text-gray-700">電話番号</dt>
              <dd class="text-gray-900"><%= @business_card.telephone_number.presence || "取得できませんでした" %></dd>
            </div>
            <div>
              <dt class="font-medium text-gray-700">メールアドレス</dt>
              <dd class="text-gray-900"><%= @business_card.mail.presence || "取得できませんでした" %></dd>
            </div>
            <div>
              <dt class="font-medium text-gray-700">住所</dt>
              <dd class="text-gray-900"><%= @business_card.address.presence || "取得できませんでした" %></dd>
            </div>
          </dl>
        </div>
      </div>
    </div>
  </div>
</div>
```

## 実行手順

### 1. サーバー起動
```bash
rails server
```

### 2. アクセス
ブラウザで `http://localhost:3000` にアクセス

## 注意事項

1. **API キー設定**: Gemini APIキーを必ず設定してください
2. **画像フォーマット**: JPEG、PNG形式のみ対応
3. **エラーハンドリング**: API失敗時はraw_responseに詳細を保存
4. **セキュリティ**: 本番環境では認証機能の追加を検討してください

## 拡張可能な機能

- 名刺一覧・検索機能
- 読み取り結果の手動編集機能
- CSV/vCardエクスポート機能
- 複数画像の一括処理
- 読み取り精度向上のための画像前処理

## トラブルシューティング

### よくある問題
1. **API Key not found**: credentials.yml.encの設定を確認
2. **Image format error**: アップロード画像の形式を確認
3. **JSON parse error**: Gemini APIレスポンスの形式を確認
4. **Missing gem**: `bundle install`を実行

### デバッグ方法
- `rails console`でGeminiService.analyze_business_cardを直接実行
- `raw_response`カラムでAPI生レスポンスを確認
- `rails log`でエラーログを確認